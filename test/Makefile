# A Makefile for fusing Google Test and building a sample test against it.
#
# SYNOPSIS:
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make check  - makes everything and runs the built sample test.
#   make clean  - removes all files generated by make.

CXX = g++-10

FUSED_GTEST_DIR = .

FUSED_GTEST_H = $(FUSED_GTEST_DIR)/gtest/gtest.h
FUSED_GTEST_ALL_CC = $(FUSED_GTEST_DIR)/gtest/gtest-all.cc

# Where to find the sample test.
TEST_DIR = src

# Where to find gtest_main.cc.
GTEST_MAIN_CC = src/gtest_main.cc

# Flags passed to the preprocessor.
# We have no idea here whether pthreads is available in the system, so
# disable its use.
CPPFLAGS += -I$(FUSED_GTEST_DIR) -DGTEST_HAS_PTHREAD=0

# Flags passed to the C++ compiler.
CXX = clang++
CXXFLAGS = -Wall -Wextra -Weffc++ -Wfloat-equal -Wshadow\
	-Wpointer-arith -Wcast-align -Wstrict-overflow=5\
	-Wwrite-strings -Wswitch-default -Wswitch-enum -Wparentheses\
	-Woverloaded-virtual -Wl -pedantic -g -std=c++11
all : ivantest

check : all
	./ivantest

clean :
	rm -rf *.o



.PHONY: $(FUSED_GTEST_H) $(FUSED_GTEST_ALL_CC) $(GTEST_MAIN_CC)
gtest-all.o : $(FUSED_GTEST_H) $(FUSED_GTEST_ALL_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(FUSED_GTEST_DIR)/gtest/gtest-all.cc

gtest_main.o : $(FUSED_GTEST_H) $(GTEST_MAIN_CC)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(GTEST_MAIN_CC)


astTests.o : $(TEST_DIR)/astTests.cpp
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I../lib -L../build -livanlib -c $(TEST_DIR)/astTests.cpp

utility.o: $(TEST_DIR)/utility.cpp
		$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I../lib -L../build -livanlib -c $(TEST_DIR)/utility.cpp

ivantest : astTests.o utility.o gtest-all.o gtest_main.o
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -I../lib -L../build -livanlib $^ -o ../build/$@
